<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RENUOVA - Official Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<!-- FontAwesome & Google Fonts -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

<style>
/* ===== PREMIUM LOADING PAGE ===== */
#loader {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1);
    font-family: 'Inter', sans-serif;
}
.particles {
    position: absolute;
    width: 100%; height: 100%;
    background-image: radial-gradient(#ffffff 1px, transparent 1px);
    background-size: 50px 50px;
    opacity: 0.1;
    animation: moveBg 20s linear infinite;
}
@keyframes moveBg {
    from { background-position: 0 0; }
    to { background-position: 500px 500px; }
}
.brand-name {
    display: flex;
    gap: 5px;
    letter-spacing: 15px;
    animation: squeeze 1.5s ease-out forwards;
}
.letter {
    font-size: 3.5rem;
    font-weight: 900;
    color: #fff;
    text-transform: uppercase;
    display: inline-block;
    opacity: 0;
    filter: blur(10px);
    animation: reveal 0.8s cubic-bezier(0.17, 0.67, 0.83, 0.67) forwards;
    text-shadow: 0 0 30px rgba(56, 189, 248, 0.8);
}
.letter:nth-child(1) { animation-delay: 0.1s; color: #38bdf8; }
.letter:nth-child(2) { animation-delay: 0.2s; }
.letter:nth-child(3) { animation-delay: 0.3s; }
.letter:nth-child(4) { animation-delay: 0.4s; }
.letter:nth-child(5) { animation-delay: 0.5s; }
.letter:nth-child(6) { animation-delay: 0.6s; }
.letter:nth-child(7) { animation-delay: 0.7s; color: #38bdf8; }

.loader-line-container {
    width: 250px; height: 2px;
    background: rgba(255, 255, 255, 0.05);
    margin-top: 40px;
    position: relative;
    overflow: hidden;
}
.loader-line {
    position: absolute;
    height: 100%; width: 40%;
    background: linear-gradient(90deg, transparent, #38bdf8, transparent);
    animation: lineMove 1.5s infinite ease-in-out;
}
@keyframes reveal { to { opacity: 1; filter: blur(0); transform: translateY(0); } }
@keyframes squeeze { to { letter-spacing: 5px; } }
@keyframes lineMove { 0% { left: -100%; } 100% { left: 100%; } }

/* ===== UI CSS ===== */
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#f1f3f6; color:#333;}
header{background:#2874f0;color:#fff;padding:14px;display:flex; justify-content: space-between; align-items: center; font-size:20px;font-weight:700; position: sticky; top:0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:12px;}
.card{background:#fff;border-radius:10px;padding:8px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.1);transition:.2s;}
.card:active{transform:scale(.97)}
.card img{width:100%;height:170px;object-fit:contain;border-radius:8px;}
.card h3{margin:6px 0 2px;font-size:15px;font-weight:600; color:#333; height: 36px; overflow: hidden;}
.card p{margin:0;color:#388e3c;font-weight:700;}

.page{display:none;padding:12px; animation: fadeIn 0.3s;}
@keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

/* POSTER SLIDER */
.home-poster-container { padding: 10px; display: block; }
.poster-slider { width: 100%; height: 180px; background: #ddd; border-radius: 10px; overflow: hidden; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
@media (min-width: 600px) { .poster-slider { height: 280px; } }
.poster-slider img { width: 100%; height: 100%; object-fit: cover; }

/* PRODUCT DETAILS SLIDER */
.slider{position:relative;background:#fff;padding:10px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1); text-align: center;}
.slider img{width:100%;height:280px;object-fit:contain;border-radius:10px;}
.arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.8);color:#000;padding:8px 12px;border-radius:50%;cursor:pointer;font-size:18px;box-shadow:0 2px 6px rgba(0,0,0,.3); z-index: 5;}
.left{left:8px}.right{right:8px}

/* BUTTONS */
.btn{background:#fb641b;color:#fff;padding:14px;text-align:center;border-radius:8px;margin-top:12px;text-decoration:none;display:block;font-weight:700; border:none; width:100%; cursor:pointer; font-size: 16px;}
.btn.dark{background:#2874f0}
.btn.cart-btn{background:#ff9f00; margin-bottom: 5px;}
.back-btn { width: auto !important; display: inline-block !important; padding: 8px 18px !important; font-size: 14px !important; margin-bottom: 10px !important; }

input,textarea{width:100%;padding:12px;margin:6px 0;border-radius:6px;border:1px solid #ccc; box-sizing: border-box; font-size: 14px;}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px; font-size: 11px;}
th,td{border:1px solid #ddd;padding:6px;text-align:center;}

/* AUTH & CART PAGES */
#authPage, #cartPage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2500; display: none; padding: 20px; box-sizing: border-box; overflow-y: auto; }
.badge { background: #ff3f6c; color: white; border-radius: 50%; padding: 2px 6px; font-size: 11px; vertical-align: middle; margin-left: 3px; border: 1px solid #fff; }

/* CHAT CSS */
#supportChatPage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: none; flex-direction: column; }
.chat-header { background: #2874f0; color: #fff; padding: 15px; display: flex; align-items: center; gap: 10px; font-weight: bold; }
#chatMessages { flex: 1; overflow-y: auto; padding: 15px; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px; }
.msg { max-width: 80%; padding: 10px; border-radius: 10px; font-size: 14px; }
.msg.user { align-self: flex-end; background: #2874f0; color: #fff; border-bottom-right-radius: 2px; }
.msg.admin { align-self: flex-start; background: #e0e0e0; color: #333; border-bottom-left-radius: 2px; }
.chat-input-box { padding: 10px; border-top: 1px solid #ddd; display: flex; gap: 8px; background:#fff;}
.chat-input-box input { margin: 0; flex: 1; }

.admin-chat-card { background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.btn-delete-chat { background: #d32f2f; color: #fff; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }
</style>
</head>

<body>

<!-- LOADING SCREEN -->
<div id="loader">
    <div class="particles"></div>
    <div class="brand-name">
        <span class="letter">R</span>
        <span class="letter">E</span>
        <span class="letter">N</span>
        <span class="letter">U</span>
        <span class="letter">O</span>
        <span class="letter">V</span>
        <span class="letter">A</span>
    </div>
    <div class="loader-line-container">
        <div class="loader-line"></div>
    </div>
</div>

<div id="mainSite" style="display:none; opacity: 0; transition: opacity 1s ease;">

<header>
    <div onclick="openSupport()" style="font-size: 13px; font-weight: normal; cursor: pointer;"><i class="fa fa-headset"></i> Support</div>
    <div id="logo" onclick="goHome()" style="cursor: pointer; letter-spacing: 2px;">RENUOVA</div>
    <div style="display: flex; gap: 12px; align-items: center; font-size: 16px;">
        <div onclick="openCart()" style="cursor: pointer;"><i class="fa fa-shopping-cart"></i><span id="cartCount" class="badge">0</span></div>
        <div id="userBtn" onclick="openAuth()" style="cursor: pointer; font-size: 14px; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px;"><i class="fa fa-user-circle"></i> Login</div>
    </div>
</header>

<!-- HOME SECTION -->
<div id="homeSection">
    <div style="padding:10px;background:#f1f3f6;">
      <input id="searchBox" type="search" placeholder="Search products..." onkeyup="searchProduct(event)">
    </div>
    <div class="home-poster-container">
        <div class="poster-slider">
            <img id="homePosterImg" src="https://via.placeholder.com/600x200?text=Mega+Sale+Offer">
        </div>
    </div>
    <div id="home" class="grid">Loading products...</div>
</div>

<!-- AUTH PAGE -->
<div id="authPage">
    <button class="btn dark back-btn" onclick="closeAuth()">‚úï Close</button>
    <div id="authContent" style="max-width: 400px; margin: auto; padding-top: 20px;">
        <div id="loginSection">
            <h2 style="text-align:center;">Member Login</h2>
            <p style="text-align:center; color:#666; margin-bottom: 20px;">Login/Register to continue shopping</p>
            <input type="text" id="authName" placeholder="Enter Full Name (New Users)">
            <input type="email" id="authEmail" placeholder="Enter Valid Email (e.g. user@gmail.com)">
            <input type="password" id="authPass" placeholder="Enter Password (min 6 chars)">
            <button class="btn" id="authSubmitBtn" onclick="handleAuth()">Login / Create Account</button>
            <p style="font-size: 11px; color: #e63946; margin-top: 10px; text-align: center; display:none;" id="authError"></p>
        </div>
        <div id="profileSection" style="display:none; text-align: center;">
            <div style="font-size: 60px; color: #2874f0; margin-bottom: 10px;"><i class="fa fa-user-circle"></i></div>
            <h2 id="profNameDisplay">User Name</h2>
            <p id="profEmailDisplay" style="color:#666;"></p>
            <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <button class="btn dark" onclick="logout()">Sign Out</button>
            </div>
        </div>
    </div>
</div>

<!-- CART PAGE -->
<div id="cartPage">
    <button class="btn dark back-btn" onclick="closeCart()">‚¨Ö Back</button>
    <h2 style="border-bottom: 2px solid #2874f0; padding-bottom: 10px;">My Cart</h2>
    <div id="cartItemsList"></div>
    <div id="cartEmptyMsg" style="text-align:center; padding:50px 20px; display:none;">
        <i class="fa fa-shopping-basket" style="font-size: 50px; color: #ccc;"></i>
        <p>Your cart is empty!</p>
    </div>
</div>

<!-- SUPPORT CHAT -->
<div id="supportChatPage">
    <div class="chat-header">
        <i class="fa fa-arrow-left" onclick="closeSupport()"></i>
        <span>Support Center</span>
    </div>
    <div id="chatMessages"></div>
    <div class="chat-input-box">
        <input type="text" id="userChatInput" placeholder="Describe your issue...">
        <button class="btn dark" style="margin:0; width:auto;" onclick="sendUserMsg()">Send</button>
    </div>
</div>

<!-- PRODUCT DETAILS PAGE -->
<div id="product" class="page">
    <button class="btn dark back-btn" onclick="goHome()">‚¨Ö Back to Store</button>
    <div class="slider">
        <img id="slideImg">
        <div class="arrow left" onclick="prevImg()">‚Äπ</div>
        <div class="arrow right" onclick="nextImg()">‚Ä∫</div>
    </div>
    <div id="thumbBar" style="display: flex; gap: 8px; overflow-x: auto; padding: 10px 0;"></div>
    <h2 id="pname" style="margin: 15px 0 5px;"></h2>
    <h3 id="pprice" style="color: #388e3c; margin: 0 0 10px;"></h3>
    <p id="pdetails" style="line-height: 1.5; color: #555;"></p>
    <div style="background: #fff9e6; padding: 10px; border-radius: 6px; margin: 15px 0;">
        <b>Warranty:</b> <span id="pwarranty"></span>
    </div>
    <button class="btn cart-btn" onclick="addToCart()">Add to Cart</button>
    <button class="btn" onclick="triggerBuyNow()">Buy Now</button>
</div>

<!-- CHECKOUT / ORDER PAGE -->
<div id="checkoutPage" class="page" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:3000; overflow-y:auto; padding:20px; box-sizing:border-box;">
    <button class="btn dark back-btn" onclick="closeCheckout()">‚¨Ö Back</button>
    <h2>Complete Your Order</h2>
    <div id="orderSummary" style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom: 20px; border: 1px dashed #2874f0;"></div>
    
    <label>Delivery Name:</label>
    <input type="text" id="custName" placeholder="Recipient's Name">
    <label>Contact Number:</label>
    <input type="number" id="custPhone" placeholder="Mobile Number">
    <label>State:</label>
    <input type="text" id="custState" placeholder="e.g. Maharashtra">
    <label>District:</label>
    <input type="text" id="custDistrict" placeholder="e.g. Mumbai">
    <label>Pincode:</label>
    <input type="number" id="custPin" placeholder="6-digit Pincode">
    <label>Full Address:</label>
    <textarea id="custFullAddress" placeholder="Building, Street, Landmark..." rows="3"></textarea>
    
    <button class="btn" onclick="confirmOrder()">Confirm Order via WhatsApp</button>
</div>

<!-- ADMIN PANEL SECTION -->
<div id="adminList" class="page">
    <h2 style="color: #d32f2f;">Admin Dashboard</h2>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
        <button class="btn dark" onclick="goHome()">View Website</button>
        <button class="btn" onclick="addNew()">+ New Product</button>
        <button class="btn dark" onclick="showOrders()">View Orders</button>
        <button class="btn dark" onclick="showAdminSupport()">Support Chats</button>
        <button class="btn" style="background: #6200ea;" onclick="showCustomerDetails()">User Logins</button>
    </div>
    
    <table style="margin-top: 20px;">
        <thead><tr style="background:#eee;"><th>Product Name</th><th>Price</th><th>Action</th></tr></thead>
        <tbody id="plist"></tbody>
    </table>
</div>

<!-- ADMIN: LOGIN HISTORY -->
<div id="adminLoginDetails" class="page">
    <h2>Customer Login History</h2>
    <button class="btn dark back-btn" onclick="openAdminList()">‚¨Ö Back</button>
    <div style="overflow-x:auto;">
        <table>
            <thead style="background: #2874f0; color:#fff;"><tr><th>Name</th><th>Email</th><th>Password</th><th>Join Date</th></tr></thead>
            <tbody id="loginTableBody"></tbody>
        </table>
    </div>
</div>

<!-- ADMIN: ORDERS -->
<div id="adminOrders" class="page">
    <h2>Pending Orders</h2>
    <button class="btn dark back-btn" onclick="openAdminList()">‚¨Ö Back</button>
    <div style="overflow-x:auto;">
        <table>
            <thead><tr><th>Date</th><th>Product</th><th>Customer</th><th>Location</th><th>Del</th></tr></thead>
            <tbody id="orderTableBody"></tbody>
        </table>
    </div>
</div>

<!-- ADMIN: SUPPORT LIST -->
<div id="adminSupportList" class="page">
    <h2>Customer Support Inbox</h2>
    <button class="btn dark back-btn" onclick="openAdminList()">‚¨Ö Back</button>
    <div id="chatListContainer" style="padding:10px;"></div>
</div>

<!-- ADMIN: CHAT REPLY -->
<div id="adminReplyPage" class="page">
    <button class="btn dark back-btn" onclick="showAdminSupport()">‚¨Ö Back</button>
    <div id="adminChatMessages" style="height: 400px; overflow-y: auto; background: #eee; padding: 15px; display: flex; flex-direction: column; gap: 10px; border-radius: 8px;"></div>
    <div class="chat-input-box">
        <input type="text" id="adminReplyInput" placeholder="Type your reply...">
        <button class="btn" style="margin:0; width: auto;" onclick="sendAdminReply()">Reply</button>
    </div>
</div>

<!-- ADMIN: ADD/EDIT FORM -->
<div id="adminEdit" class="page">
    <h2 id="formTitle">Product Editor</h2>
    <button class="btn dark back-btn" onclick="openAdminList()">‚¨Ö Cancel</button>
    <label>Product Name</label><input id="aname">
    <label>Price (with symbol)</label><input id="aprice">
    <label>Images (URLs)</label>
    <input id="img1" placeholder="Main Image URL">
    <input id="img2" placeholder="Image 2 URL">
    <input id="img3" placeholder="Image 3 URL">
    <label>Full Description</label><textarea id="adetails" rows="4"></textarea>
    <label>Warranty Info</label><input id="awarranty">
    <button class="btn" onclick="save()">Save to Database</button>
</div>

</div>

<script>
/* FIREBASE CONFIGURATION */
const firebaseConfig={
 apiKey:"AIzaSyBzfvl9ZcvApNZf7kFih7oCvGkYLSAKm0",
 authDomain:"nuova-87735.firebaseapp.com",
 databaseURL:"https://nuova-87735-default-rtdb.firebaseio.com",
 projectId:"nuova-87735",
 storageBucket:"nuova-87735.firebasestorage.app",
 messagingSenderId:"299058177938",
 appId:"1:299058177938:web:a0bcf1a1d141fe7a58434b"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database().ref("products");
const dbP=firebase.database().ref("posters");
const dbO=firebase.database().ref("orders");
const dbChat=firebase.database().ref("support_chats");
const dbU=firebase.database().ref("users");

/* GLOBAL VARIABLES */
let products=[], editIndex=null, slideIndex=0, currentImgs=[];
let homePosters = ["https://via.placeholder.com/600x200"];
let posterTick = 0;
let selectedProduct = null;
let cart = JSON.parse(localStorage.getItem("renuova_cart")) || [];
let currentUser = null;

const myChatId = localStorage.getItem("renuova_chat_id") || "User_" + Math.floor(Math.random() * 1000000);
localStorage.setItem("renuova_chat_id", myChatId);

/* INITIALIZATION */
window.onload = () => {
  setTimeout(()=>{
    const loader = document.getElementById("loader");
    const site = document.getElementById("mainSite");
    loader.style.transform = "translateY(-100%)";
    site.style.display="block";
    setTimeout(() => site.style.opacity = "1", 50);
    checkUserSession();
    updateCartBadge();
  }, 2500);
};

/* DATA SYNC */
db.on("value",(s)=>{ 
    products=s.val()||[]; 
    loadHome(); 
    if(document.getElementById("adminList").style.display==="block") renderList(); 
});
dbP.on("value", (s) => { if(s.val()){ homePosters = s.val(); updatePosterImage(); }});
setInterval(() => { posterTick = (posterTick + 1) % homePosters.length; updatePosterImage(); }, 4000);

function updatePosterImage() { const imgEl = document.getElementById("homePosterImg"); if(imgEl) imgEl.src = homePosters[posterTick]; }

function loadHome(){
 const home = document.getElementById("home");
 home.innerHTML="";
 products.forEach((x,i)=>{
  home.innerHTML+=`<div class="card" onclick="openP(${i})"><img src="${x.imgs[0]}"><h3>${x.n}</h3><p>${x.p}</p></div>`;
 });
}

/* PRODUCT VIEW */
window.openP=function(i){
 document.getElementById("homeSection").style.display="none";
 document.getElementById("product").style.display="block";
 selectedProduct = products[i];
 currentImgs=products[i].imgs;
 slideIndex=0;
 const thumbBar = document.getElementById("thumbBar");
 thumbBar.innerHTML = "";
 currentImgs.forEach((imgSrc, idx) => {
     let t = document.createElement("img");
     t.src = imgSrc; t.style = "width:60px; height:60px; object-fit:contain; border:2px solid #ddd; border-radius:5px; flex-shrink:0; cursor:pointer;";
     t.onclick = () => { slideIndex=idx; updateUI(); };
     thumbBar.appendChild(t);
 });
 updateUI();
 document.getElementById("pname").innerText=products[i].n;
 document.getElementById("pprice").innerText=products[i].p;
 document.getElementById("pdetails").innerText=products[i].d;
 document.getElementById("pwarranty").innerText=products[i].w;
 window.scrollTo(0,0);
}
function updateUI() { document.getElementById("slideImg").src = currentImgs[slideIndex]; }
function prevImg(){ slideIndex = (slideIndex-1+currentImgs.length)%currentImgs.length; updateUI(); }
function nextImg(){ slideIndex = (slideIndex+1)%currentImgs.length; updateUI(); }

/* AUTHENTICATION */
function openAuth() { document.getElementById("authPage").style.display = "block"; }
function closeAuth() { document.getElementById("authPage").style.display = "none"; }
function isValidEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

function handleAuth() {
    let name = document.getElementById("authName").value.trim();
    let email = document.getElementById("authEmail").value.trim().toLowerCase();
    let pass = document.getElementById("authPass").value.trim();
    let errorEl = document.getElementById("authError");
    errorEl.style.display = "none";
    if(!email || !pass) return showAuthError("Email and Password are required!");
    if(!isValidEmail(email)) return showAuthError("Please enter a valid email address!");
    if(pass.length < 6) return showAuthError("Password must be at least 6 characters!");

    let userKey = email.replace(/[.$#[\]]/g, "_");
    const btn = document.getElementById("authSubmitBtn");
    btn.disabled = true; btn.innerText = "Processing...";

    dbU.child(userKey).once("value", (snapshot) => {
        let existingUser = snapshot.val();
        if(existingUser) {
            if(existingUser.pass === pass) completeLogin(existingUser);
            else { showAuthError("Wrong password!"); btn.disabled = false; btn.innerText = "Login / Create Account"; }
        } else {
            if(!name) { showAuthError("New user? Enter Full Name."); btn.disabled = false; btn.innerText = "Login / Create Account"; return; }
            let userData = { name, email, pass, date: new Date().toLocaleString() };
            dbU.child(userKey).set(userData).then(() => completeLogin(userData));
        }
    });
}
function showAuthError(msg) { let errorEl = document.getElementById("authError"); errorEl.innerText = msg; errorEl.style.display = "block"; }
function completeLogin(userData) {
    localStorage.setItem("renuova_user", JSON.stringify(userData));
    alert("Welcome, " + userData.name);
    checkUserSession(); closeAuth();
    document.getElementById("authSubmitBtn").disabled = false; document.getElementById("authSubmitBtn").innerText = "Login / Create Account";
}
function checkUserSession() {
    let user = localStorage.getItem("renuova_user");
    if(user) {
        currentUser = JSON.parse(user);
        document.getElementById("userBtn").innerHTML = `<i class="fa fa-user"></i> Profile`;
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("profileSection").style.display = "block";
        document.getElementById("profNameDisplay").innerText = currentUser.name;
        document.getElementById("profEmailDisplay").innerText = currentUser.email;
    } else {
        currentUser = null;
        document.getElementById("userBtn").innerHTML = `<i class="fa fa-user-circle"></i> Login`;
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("profileSection").style.display = "none";
    }
}
function logout() { if(confirm("Sign out?")) { localStorage.removeItem("renuova_user"); location.reload(); } }

/* CART & CHECKOUT */
function updateCartBadge() { document.getElementById("cartCount").innerText = cart.length; }
function addToCart() {
    if(!selectedProduct) return;
    cart.push(selectedProduct);
    localStorage.setItem("renuova_cart", JSON.stringify(cart));
    updateCartBadge(); alert("Added to cart!");
}
function openCart() { document.getElementById("cartPage").style.display = "block"; renderCart(); }
function closeCart() { document.getElementById("cartPage").style.display = "none"; }
function renderCart() {
    const list = document.getElementById("cartItemsList");
    list.innerHTML = "";
    if(cart.length === 0) { document.getElementById("cartEmptyMsg").style.display = "block"; return; }
    document.getElementById("cartEmptyMsg").style.display = "none";
    cart.forEach((item, index) => {
        list.innerHTML += `<div style="display:flex; align-items:center; gap:10px; background:#fff; padding:10px; border-radius:10px; margin-bottom:10px;">
            <img src="${item.imgs[0]}" style="width:50px; height:50px; object-fit:contain;">
            <div style="flex:1;"><b>${item.n}</b><br><span style="color:green;">${item.p}</span></div>
            <button onclick="removeFromCart(${index})" style="color:red; background:none; border:none;"><i class="fa fa-trash"></i></button>
        </div>`;
    });
}
function removeFromCart(i) { cart.splice(i, 1); localStorage.setItem("renuova_cart", JSON.stringify(cart)); updateCartBadge(); renderCart(); }

function triggerBuyNow() {
    if(!currentUser) { alert("Please login first!"); openAuth(); return; }
    document.getElementById("orderSummary").innerHTML = `<b>üõçÔ∏è Product:</b> ${selectedProduct.n}<br><b>üí∞ Price:</b> ${selectedProduct.p}`;
    document.getElementById("custName").value = currentUser.name;
    document.getElementById("checkoutPage").style.display = "block";
}
function closeCheckout() { document.getElementById("checkoutPage").style.display = "none"; }

/* FIXED WHATSAPP DETAILS FUNCTION */
function confirmOrder() {
    let name = document.getElementById("custName").value.trim();
    let phone = document.getElementById("custPhone").value.trim();
    let state = document.getElementById("custState").value.trim();
    let dist = document.getElementById("custDistrict").value.trim();
    let pin = document.getElementById("custPin").value.trim();
    let addr = document.getElementById("custFullAddress").value.trim();
    
    if(!name || !phone || !state || !dist || !pin || !addr) return alert("All address fields are required!");

    let orderData = { 
        productName: selectedProduct.n, price: selectedProduct.p, 
        customerName: name, phone: phone, location: `${dist}, ${state}`,
        pincode: pin, address: addr, userEmail: currentUser.email, date: new Date().toLocaleString() 
    };

    dbO.push(orderData).then(() => {
        // Updated WhatsApp Message with all details
        let msg = `*üõçÔ∏è NEW ORDER - RENUOVA*%0A%0A` +
                  `*--- Product Info ---*%0A` +
                  `*Product:* ${selectedProduct.n}%0A` +
                  `*Price:* ${selectedProduct.p}%0A%0A` +
                  `*--- Customer Info ---*%0A` +
                  `*Name:* ${name}%0A` +
                  `*Phone:* ${phone}%0A%0A` +
                  `*--- Delivery Address ---*%0A` +
                  `*Address:* ${addr}%0A` +
                  `*District:* ${dist}%0A` +
                  `*State:* ${state}%0A` +
                  `*Pincode:* ${pin}%0A%0A` +
                  `*Email:* ${currentUser.email}`;
                  
        window.open(`https://wa.me/9229288001?text=${msg}`);
        closeCheckout(); goHome();
    });
}

/* SEARCH */
function searchProduct(e){
  let q = e.target.value.toLowerCase();
  let filtered = products.filter(p => p.n.toLowerCase().includes(q));
  const home = document.getElementById("home");
  home.innerHTML = "";
  filtered.forEach((x)=>{ 
      let idx = products.indexOf(x);
      home.innerHTML += `<div class="card" onclick="openP(${idx})"><img src="${x.imgs[0]}"><h3>${x.n}</h3><p>${x.p}</p></div>`; 
  });
}

/* ADMIN SYSTEM */
window.goHome=()=>{ 
    document.querySelectorAll(".page").forEach(p=>p.style.display="none"); 
    document.getElementById("homeSection").style.display="block"; 
}

let logoClickCount = 0;
document.getElementById("logo").onclick=()=>{
    logoClickCount++;
    if(logoClickCount===10){
        let pass = prompt("Admin Password:");
        if(pass==="nitish20086"){ 
            document.getElementById("homeSection").style.display="none"; 
            document.getElementById("adminList").style.display="block"; 
            renderList(); 
        } else alert("Unauthorized!");
        logoClickCount=0;
    }
}

function renderList(){
 const plist = document.getElementById("plist");
 plist.innerHTML="";
 products.forEach((x,i)=>{
  plist.innerHTML+=`<tr><td>${x.n}</td><td>${x.p}</td><td><button onclick="editProduct(${i})">Edit</button> <button onclick="del(${i})" style="background:red; color:#fff;">X</button></td></tr>`;
 });
}

window.save = () => {
    let name = document.getElementById("aname").value.trim();
    let price = document.getElementById("aprice").value.trim();
    if(!name || !price) { alert("Name and Price required!"); return; }
    let imgs = [document.getElementById("img1").value.trim(), document.getElementById("img2").value.trim(), document.getElementById("img3").value.trim()].filter(u => u);
    let productObj = { n: name, p: price, imgs: imgs.length ? imgs : ["https://via.placeholder.com/500"], d: document.getElementById("adetails").value, w: document.getElementById("awarranty").value };
    if (editIndex === null) products.push(productObj); else products[editIndex] = productObj;
    db.set(products).then(() => { alert("Saved!"); editIndex = null; openAdminList(); });
}

window.editProduct=(i)=>{
    editIndex=i;
    document.getElementById("formTitle").innerText="Edit Product";
    document.getElementById("adminList").style.display="none";
    document.getElementById("adminEdit").style.display="block";
    document.getElementById("aname").value=products[i].n;
    document.getElementById("aprice").value=products[i].p;
    document.getElementById("img1").value=products[i].imgs[0]||"";
    document.getElementById("img2").value=products[i].imgs[1]||"";
    document.getElementById("img3").value=products[i].imgs[2]||"";
    document.getElementById("adetails").value=products[i].d;
    document.getElementById("awarranty").value=products[i].w;
}

window.addNew=()=>{
    editIndex=null;
    document.getElementById("formTitle").innerText="Add New Product";
    document.getElementById("adminList").style.display="none";
    document.getElementById("adminEdit").style.display="block";
    document.getElementById("aname").value = document.getElementById("aprice").value = "";
    document.getElementById("adetails").value = document.getElementById("awarranty").value = "";
}

window.openAdminList=()=>{ 
    document.querySelectorAll(".page").forEach(p=>p.style.display="none"); 
    document.getElementById("adminList").style.display="block"; 
    renderList(); 
}

window.del=(i)=>{ if(confirm("Delete?")){ products.splice(i,1); db.set(products); } }

/* ADMIN: OTHER VIEWS */
window.showCustomerDetails = () => {
    document.querySelectorAll(".page").forEach(p => p.style.display = "none");
    document.getElementById("adminLoginDetails").style.display = "block";
    dbU.once("value", (s) => {
        let data = s.val(), html = "";
        for(let k in data) html += `<tr><td>${data[k].name}</td><td>${data[k].email}</td><td>${data[k].pass}</td><td>${data[k].date}</td></tr>`;
        document.getElementById("loginTableBody").innerHTML = html || "<tr><td colspan='4'>No users.</td></tr>";
    });
}
window.showOrders = () => {
    document.querySelectorAll(".page").forEach(p => p.style.display = "none");
    document.getElementById("adminOrders").style.display = "block";
    dbO.on("value", (s) => {
        let orders = s.val(), html = "";
        for(let k in orders) html += `<tr><td>${orders[k].date}</td><td>${orders[k].productName}</td><td>${orders[k].customerName}</td><td>${orders[k].location}</td><td><button onclick="delOrder('${k}')">X</button></td></tr>`;
        document.getElementById("orderTableBody").innerHTML = html || "<tr><td colspan='5'>No orders.</td></tr>";
    });
}
window.delOrder = (id) => { if(confirm("Delete order?")) dbO.child(id).remove(); }

/* CHAT SYSTEM */
function openSupport() { document.getElementById("supportChatPage").style.display = "flex"; loadUserMessages(); }
function closeSupport() { document.getElementById("supportChatPage").style.display = "none"; }
function loadUserMessages() {
    dbChat.child(myChatId).child("messages").on("value", (s) => {
        const msgDiv = document.getElementById("chatMessages"); msgDiv.innerHTML = "";
        s.forEach((snap) => { let m = snap.val(); msgDiv.innerHTML += `<div class="msg ${m.sender}">${m.text}</div>`; });
        msgDiv.scrollTop = msgDiv.scrollHeight;
    });
}
function sendUserMsg() {
    const input = document.getElementById("userChatInput"); if(!input.value.trim()) return;
    dbChat.child(myChatId).child("messages").push({ sender: "user", text: input.value, time: Date.now() });
    dbChat.child(myChatId).update({ lastMsg: input.value, chatId: myChatId, lastTime: Date.now() });
    input.value = "";
}

/* ADMIN CHAT */
function showAdminSupport() {
    document.querySelectorAll(".page").forEach(p => p.style.display = "none");
    document.getElementById("adminSupportList").style.display = "block";
    dbChat.on("value", (s) => {
        const chats = s.val(), container = document.getElementById("chatListContainer"); container.innerHTML = "";
        for(let id in chats) container.innerHTML += `<div class="admin-chat-card"><div onclick="openAdminReply('${id}')"><b>${id}</b><br><small>${chats[id].lastMsg}</small></div><button onclick="deleteChat(event, '${id}')">X</button></div>`;
    });
}
let activeAdminChat = "";
function openAdminReply(id) {
    activeAdminChat = id; document.getElementById("adminSupportList").style.display = "none"; document.getElementById("adminReplyPage").style.display = "block";
    dbChat.child(id).child("messages").on("value", (s) => {
        const msgDiv = document.getElementById("adminChatMessages"); msgDiv.innerHTML = "";
        s.forEach((snap) => { let m = snap.val(); msgDiv.innerHTML += `<div class="msg ${m.sender}">${m.text}</div>`; });
        msgDiv.scrollTop = msgDiv.scrollHeight; 
    });
}
function sendAdminReply() {
    const input = document.getElementById("adminReplyInput"); if(!input.value.trim()) return;
    dbChat.child(activeAdminChat).child("messages").push({ sender: "admin", text: input.value, time: Date.now() });
    input.value = "";
}
function deleteChat(e, id) { e.stopPropagation(); if(confirm("Delete chat?")) dbChat.child(id).remove(); }
</script>

</body>
</html>